
blueprint:
  name: Koszenie trawnika - elastyczne okno z powiadomieniem
  description: >
    Uruchamia kosiarkę w określonym oknie czasowym, jeśli spełnione są warunki pogodowe.
    Wysyła powiadomienie, jeśli opcja jest włączona.
  domain: automation
  input:
    mower_entity:
      name: Kosiarka
      selector:
        entity:
          domain: lawn_mower
    rain_sensor:
      name: Czujnik deszczu
      selector:
        entity:
          domain: binary_sensor
    rain_forecast_sensor:
      name: Sensor prognozowanych opadów
      selector:
        entity:
          domain: sensor
    rain_threshold:
      name: Próg opadów (mm)
      default: 4
      selector:
        number:
          min: 0
          max: 20
          step: 0.1
          unit_of_measurement: mm
          mode: slider
    mowing_start:
      name: Początek okna koszenia
      selector:
        time: {}
    mowing_end:
      name: Koniec okna koszenia
      selector:
        time: {}
    notify_device:
      name: Urządzenie mobilne (mobile_app)
      selector:
        device:
          integration: mobile_app
    notify_enabled:
      name: Czy wysyłać powiadomienie?
      default: true
      selector:
        boolean: {}
    notify_message:
      name: Treść powiadomienia
      default: "Heniek rozpoczął koszenie w elastycznym oknie czasowym."
      selector:
        text:
          multiline: true

trigger:
  - platform: time_pattern
    minutes: "/5"

condition:
  - condition: time
    after: !input mowing_start
    before: !input mowing_end
  - condition: state
    entity_id: !input rain_sensor
    state: "off"
  - condition: numeric_state
    entity_id: !input rain_forecast_sensor
    above: !input rain_threshold
  - condition: state
    entity_id: !input mower_entity
    state: "docked"

action:
  - service: lawn_mower.start_mowing
    target:
      entity_id: !input mower_entity

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (true == (inputs.notify_enabled | default(true))) }}"
        sequence:
          - domain: mobile_app
            type: notify
            device_id: !input notify_device
            message: !input notify_message

mode: single
